{% import _self as self %}

{% macro treenode(data, documents, translation_domain, select_only_mode, readonly) %}
    {% import _self as self %}

    {% set document = documents[data.identifier] %}
    <li id="{{data.identifier}}" class="child {% if data.children|length > 0 %}expandable{% endif %}"
    {% if false == select_only_mode and false == readonly %}draggable="true"{% endif %} data-document="{{document|json_encode}}">
        <label class="node-label">
            {% if data.children|length > 0 %}
            <span class="node-toggle hb-icon-minus"></span>
            {% else %}
            <span class="node-toggle">〉</span>
            {% endif %}
            {% if true == select_only_mode or false == readonly %}
            <input type="checkbox" class="check" />
            {% endif %}
            <span class="name">{{data.label}}</span>
        </label>
        {% if false == select_only_mode and false == readonly %}
        <ul class="node-controls">
            <li class="control">
                <div class="btn-group dropdown">
                        <button class="btn btn-primary honeybee-action honeybee-action-edit" {% if not document.workflow.interactive %}disabled="disabled"{% endif %}>
                            {{tm._('edit', translation_domain)}}
                        </button>
                    {% if document.workflow.gates|length > 0 %}
                    <button class="btn dropdown-toggle btn-primary" data-toggle="dropdown">
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu pull-right">
                        {% for gate in document.workflow.gates %}
                        <li>
                            <a class="honeybee-action-proceed" data-gate="{{gate.name}}">{{gate.label}}</a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </li>
            <li class="control">
                <a class="move">
                    <span class="control-label">Verschieben</span>
                    <i class="hb-icon-move"></i>
                </a>
                <a class="move-cancel hide">
                    <span class="control-label">Abbrechen</span>
                </a>
                <ul class="move-target hide">
                    <li class="move-before" title="{{tm._('Vor diesem Eintrag einfügen', translation_domain)}}"><span class="arrow">▲</span></li>
                    <li class="move-after" title="{{tm._('Nach diesem Eintrag einfügen', translation_domain)}}"><span class="arrow">▼</span></li>
                    <li class="move-inside" title="{{tm._('Als Kind an diesen Eintrag anhängen', translation_domain)}}"><span class="arrow">▶</span></li>
                </ul>
            </li>
        </ul>
        {% endif %}
        {% if data.children|length > 0 %}
        <ul class="children">
        {% for child in data.children %}
            {{ self.treenode(child, documents, translation_domain, select_only_mode, readonly) }}            
        {% endfor %}
        </ul>
        {% endif %}
    </li>
{% endmacro %}

<section class="container-tree-data row-fluid"
    data-controller="{{client_side_controller.implementor}}"
    data-controller-options="{{client_side_controller.options|json_encode}}">

    <section class="container-alerts"
         data-bind="template: { foreach: alerts, afterAdd: showAlert, beforeRemove: hideAlert }">
        <div class="alert"
             data-bind="css: {
                            'alert-success': 'success' === type,
                            'alert-error': 'error' === type
                        }">
            <strong data-bind="text: message"></strong>
            <i class="hb-icon-cancel close"
               data-bind="click: function(alert) { $parent.removeAlert(alert); }"> </i>
        </div>
    </section>

<!-- **************************************************
    Tree Controls/Widgets such as search and batch processing.
************************************************** -->
    <section class="well toolbar primary">
        <div class="container-viewcontrols">
            <section class="view-mode-switch">
                <div class="btn-group" data-toggle="radio">
                    <a class="btn btn-primary" href="{{list_view_link}}">Liste</a>
                    <a class="btn active btn-primary" href="{{tree_view_link}}">Hierarchie</a>
                </div>
            </section>
        </div>
        {% if false == select_only_mode %}
        <div class="container-actions clearfix">
            {% if create_link %}
            <section>
                <a class="btn hb-icon-file-4" href="{{ro.gen(module_type_key ~ '.edit')}}"> Neuer Eintrag</a>
            </section>
            {% endif %}
            {% if false == readonly %}
            <section>
                <div class="btn-group">
                    <a class="btn btn-warning dropdown-toggle" data-toggle="dropdown" href="#">
                        Stapelverarbeitung
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                    {% for action_name, action in batch_actions %}
                        <li>
                            <a class="honeybee-action honeybee-action-{{action_name}}" data-action="{{action}}">
                                {{ tm._(action_name, translation_domain) }}
                            </a>
                        </li>
                    {% endfor %}
                    </ul>
                </div>
            </section>
            {% endif %}
        </div>
        {% endif %}
    </section>

    <section class="render-tree">
        <ul class="children">
        {% for node in tree.rootNode.children %}
            {{ self.treenode(node, documents, translation_domain, select_only_mode, readonly) }}
        {% endfor %}
        </ul>
    </section>

    <script class="tree-data-json" type="application/json">
        {{tree|json_encode|raw}}
    </script>
</section>

<!-- **************************************************
Modal dialogs
************************************************** -->
<div class="modal modal-batch-progress" style="display:none">
    <div class="modal-header">
        <h3>Fortschritt</h3>
    </div>
    <div class="modal-body">
        <div class="progress progress-striped active">
            <div class="bar" style="width: 0%;"></div>
        </div>
    </div>
    <div class="modal-footer">
        <a href="#" data-twodal-event="cancelbatch" class="btn btn-primary">Batchedit abbrechen</a>
    </div>
</div>

<div class="modal dialog-confirm" style="display:none">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">×</a>
        <h4>Bitte bestätigen</h4>
    </div>
    <div class="modal-body">
        <p class="prompt-text">Aktion wirklich durchf&uuml;hren?</p>
    </div>
    <div class="modal-footer">
        <a href="#" data-twodal-event="confirm" class="btn btn-primary">Ja</a>
    </div>
</div>

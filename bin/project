#!/bin/bash

BASEDIR="`dirname $0`/../"
PROJECT_CONFIG_FILE=`dirname $0`"/../etc/local/local.config.sh"
PROJECT_BASE_DIR=`readlink -f "$BASEDIR"`

if [ -f $PROJECT_CONFIG_FILE ] ; then
    # include the config file 
    . $PROJECT_CONFIG_FILE
else
    echo "Config file not exists: ${PROJECT_CONFIG_FILE}"
    exit 0    
fi

LOCAL_BUILD_PROPERTIES_FILE=`dirname $0`"/../etc/build/build.properties"

if [ -f $LOCAL_BUILD_PROPERTIES_FILE ] ; then
    echo "Found local.build.properties"
else
    echo "local.build.properties file not exists: ${LOCAL_BUILD_PROPERTIES_FILE}"
    exit 0    
fi

PHING_HOME="${PROJECT_BASE_DIR}/vendor/phing/phing/"

#Let's add phing classes to the php classpath
PHP_CLASSPATH=$PHING_HOME/classes:$PHP_CLASSPATH
export PHP_CLASSPATH

# Put all args in quotes
phing_exec_args="-f ${PROJECT_BASE_DIR}/etc/build/build.xml"

for arg in "$@" ; do
  phing_exec_args="$phing_exec_args \"$arg\""
done

if (test -z "$PHP_COMMAND") ; then
    # echo "WARNING: PHP_COMMAND environment not set. (Assuming php on PATH)"
    PHP_COMMAND=php
    export PHP_COMMAND
fi


phing_exec_cmd="exec $PHP_COMMAND -d html_errors=off -qC \"$PHING_HOME/bin/phing.php\" -logger phing.listener.AnsiColorLogger $phing_exec_args"

cd "$PROJECT_BASE_DIR"
eval $phing_exec_cmd

